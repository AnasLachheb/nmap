local shortport = require "shortport"
local stdnse = require "stdnse"
local nmap = require "nmap"
local comm = require "comm"

description = [[
Checks for CVE-2025-21298 - Windows OLE Remote Code Execution Vulnerability in ole32.dll.
The script attempts to send a crafted payload and observes the system's response
to determine if it is vulnerable.
]]

author = "Anas LACHHEB (lachheb.anas@gmail.com)"
license = "Same as Nmap"
categories = {"vuln", "safe"}

-- Define the script's arguments
portrule = shortport.port_or_service({135, 139, 445}, "msrpc")

action = function(host, port)
  local vuln_detected = false

  -- Step 1: Craft the payload
  local payload = [[
    {\rtf1{\object{\objdata
    0105000002000000e11ab0a0...
    }}}
  ]]

  -- Step 2: Send payload to the target
  local socket = nmap.new_socket()
  local status, err = socket:connect(host.ip, port.number)

  if not status then
    return "ERROR: Could not connect to target: " .. err
  end

  -- Send the payload
  socket:send(payload)
  local response = socket:receive_lines(1)

  -- Step 3: Analyze response
  if response and response:match("specific failure pattern or crash indicator") then
    vuln_detected = true
  end

  -- Step 4: Close socket
  socket:close()

  -- Step 5: Report results
  if vuln_detected then
    return string.format("Host %s is VULNERABLE to CVE-2025-21298", host.ip)
  else
    return string.format("Host %s is NOT vulnerable to CVE-2025-21298", host.ip)
  end
end
